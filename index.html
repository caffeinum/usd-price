<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>USD Price Tracker</title>
  <script src="https://cdn.plot.ly/plotly-latest.js"></script>

  <script type="text/javascript" language="javascript">
    const api_url = "/data.json"
    window.onload = function () {
      updatePlot()
      window.redraw = setInterval(updatePlot, 10000)
    };

    async function get(url) {
      const req = new XMLHttpRequest()
      return new Promise( (resolve, reject) => {
        req.open('GET', url, true)
        req.onreadystatechange = () => {
          if (req.readyState == 4) {
            if (req.status == 200) {
              resolve( JSON.parse(req.responseText) )
            } else {
              reject(req)
            }
          }
        }
        req.send()
      })
    }
    async function updatePlot() {
      const price_plot = document.getElementById('price_plot')
      const price_div = document.getElementById('price')


      const data = await get(api_url)
      if (!data || !data.values) return

      const x = data.values.map( point => point.x )
      const y = data.values
        .map( point => point.y )
        .map( price => 1000/price )
        // convert BTC/USD to USD/mBTC

      const currentPrice = y.slice(-1).pop() // mBTC per USD

      const trace = { x, y }

      plotXY(price_plot, trace)
      printPrice(price_div, currentPrice)
      console.log('updated', data.values)
    }

    function plotXY(plot, data) {
      data.type = 'scatter'

      Plotly.newPlot(price_plot, [ data ]);
    }

    function printPrice(div, price) {
      div.innerHTML = `${price} USD/mBTC`
    }
  </script>
  <style type="text/css">
  .price_plot {
    width: 800px;
    height: 500px;
  }
  </style>
</head>
<body>
  <h1 id="price"></h1>
  <div id="price_plot" class=""></div>
</body>
</html>
